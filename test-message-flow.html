<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消息流转测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #409eff;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-panels {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #e4e7ed;
            font-weight: bold;
        }

        .panel-content {
            padding: 16px;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px 0;
        }

        .status.success {
            background: #f0f9ff;
            color: #1890ff;
        }

        .status.error {
            background: #fff2f0;
            color: #ff4d4f;
        }

        .status.warning {
            background: #fffbe6;
            color: #faad14;
        }

        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }

        .controls {
            margin: 10px 0;
        }

        .controls button {
            background: #409eff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        .controls button:hover {
            background: #337ecc;
        }

        .controls button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
        }

        .controls input {
            padding: 6px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            margin: 2px;
        }

        @media (max-width: 768px) {
            .test-panels {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>消息流转测试工具</h1>
            <p>测试用户端发送消息，客服端接收通知的完整流程</p>
        </div>

        <div class="test-panels">
            <!-- 用户端测试 -->
            <div class="panel">
                <div class="panel-header">👤 用户端测试</div>
                <div class="panel-content">
                    <div class="status" id="userStatus">未连接</div>
                    <div class="controls">
                        <button onclick="connectUser()" id="connectUserBtn">连接用户端</button>
                        <button onclick="disconnectUser()" id="disconnectUserBtn" disabled>断开连接</button>
                    </div>
                    <div class="controls">
                        <input type="text" id="userMessage" placeholder="输入消息..." disabled>
                        <button onclick="sendUserMessage()" id="sendUserBtn" disabled>发送消息</button>
                    </div>
                    <div class="log-area" id="userLogs"></div>
                </div>
            </div>

            <!-- 客服端测试 -->
            <div class="panel">
                <div class="panel-header">🎧 客服端测试</div>
                <div class="panel-content">
                    <div class="status" id="operatorStatus">未连接</div>
                    <div class="controls">
                        <button onclick="connectOperator()" id="connectOperatorBtn">连接客服端</button>
                        <button onclick="disconnectOperator()" id="disconnectOperatorBtn" disabled>断开连接</button>
                    </div>
                    <div class="controls">
                        <button onclick="setOperatorOnline()" id="setOnlineBtn" disabled>设置在线</button>
                        <button onclick="joinSession()" id="joinSessionBtn" disabled>加入会话</button>
                    </div>
                    <div class="log-area" id="operatorLogs"></div>
                </div>
            </div>

            <!-- 服务器状态 -->
            <div class="panel">
                <div class="panel-header">🖥️ 服务器状态</div>
                <div class="panel-content">
                    <div class="status" id="serverStatus">检查中...</div>
                    <div class="controls">
                        <button onclick="checkServerStatus()">检查服务器</button>
                        <button onclick="clearAllLogs()">清空日志</button>
                    </div>
                    <div class="log-area" id="serverLogs"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">📋 测试说明</div>
            <div class="panel-content">
                <ol>
                    <li><strong>连接客服端</strong>：点击"连接客服端"按钮</li>
                    <li><strong>设置在线</strong>：点击"设置在线"按钮</li>
                    <li><strong>连接用户端</strong>：点击"连接用户端"按钮</li>
                    <li><strong>发送消息</strong>：在用户端输入消息并发送</li>
                    <li><strong>观察通知</strong>：客服端应该收到消息通知</li>
                    <li><strong>加入会话</strong>：客服点击"加入会话"按钮</li>
                    <li><strong>验证通信</strong>：确认双方可以正常通信</li>
                </ol>
                <p><strong>预期结果</strong>：用户发送消息后，客服端应该立即收到通知并显示在待处理会话中。</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let userSocket = null;
        let operatorSocket = null;
        let userId = null;
        let operatorId = null;
        let sessionId = null;

        // 日志函数
        function addLog(area, message, type = 'info') {
            const logArea = document.getElementById(area);
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#3498db',
                'success': '#2ecc71',
                'error': '#e74c3c',
                'warning': '#f39c12'
            };

            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #95a5a6;">[${timestamp}]</span> <span style="color: ${colorMap[type]};">${message}</span>`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 更新状态
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // 生成ID
        function generateId(prefix) {
            return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 连接用户端
        function connectUser() {
            try {
                addLog('userLogs', '正在连接用户端Socket...', 'info');

                userSocket = io('http://localhost:3001', {
                    transports: ['websocket', 'polling'],
                    timeout: 20000
                });

                userId = generateId('user');

                userSocket.on('connect', () => {
                    addLog('userLogs', '用户端Socket连接成功', 'success');
                    updateStatus('userStatus', '已连接', 'success');

                    document.getElementById('connectUserBtn').disabled = true;
                    document.getElementById('disconnectUserBtn').disabled = false;
                    document.getElementById('userMessage').disabled = false;
                    document.getElementById('sendUserBtn').disabled = false;

                    // 加入聊天
                    userSocket.emit('user-join-chat', {
                        userId: userId,
                        name: '测试用户',
                        timestamp: new Date().toISOString()
                    });
                });

                userSocket.on('disconnect', () => {
                    addLog('userLogs', '用户端Socket连接断开', 'warning');
                    updateStatus('userStatus', '已断开', 'error');

                    document.getElementById('connectUserBtn').disabled = false;
                    document.getElementById('disconnectUserBtn').disabled = true;
                    document.getElementById('userMessage').disabled = true;
                    document.getElementById('sendUserBtn').disabled = true;
                });

                userSocket.on('chat-session-created', (data) => {
                    sessionId = data.sessionId;
                    addLog('userLogs', `会话创建成功: ${sessionId}`, 'success');
                });

                userSocket.on('message-received', (data) => {
                    addLog('userLogs', `收到消息: ${data.content} (来自: ${data.senderType})`, 'success');
                });

                userSocket.on('operator-joined', (data) => {
                    addLog('userLogs', `客服已加入: ${data.operatorName}`, 'success');
                });

                userSocket.on('chat-error', (data) => {
                    addLog('userLogs', `错误: ${data.error}`, 'error');
                });

            } catch (error) {
                addLog('userLogs', `连接失败: ${error.message}`, 'error');
                updateStatus('userStatus', '连接失败', 'error');
            }
        }

        // 断开用户端
        function disconnectUser() {
            if (userSocket) {
                userSocket.disconnect();
                userSocket = null;
                userId = null;
                sessionId = null;
            }
        }

        // 发送用户消息
        function sendUserMessage() {
            const messageInput = document.getElementById('userMessage');
            const message = messageInput.value.trim();

            if (!message) {
                addLog('userLogs', '请输入消息内容', 'warning');
                return;
            }

            if (!userSocket || !sessionId) {
                addLog('userLogs', '请先连接并创建会话', 'error');
                return;
            }

            addLog('userLogs', `发送消息: ${message}`, 'info');

            userSocket.emit('user-send-message', {
                sessionId: sessionId,
                content: message,
                messageType: 'text'
            });

            messageInput.value = '';
        }

        // 连接客服端
        function connectOperator() {
            try {
                addLog('operatorLogs', '正在连接客服端Socket...', 'info');

                operatorSocket = io('http://localhost:3001', {
                    transports: ['websocket', 'polling'],
                    timeout: 20000
                });

                operatorId = generateId('operator');

                operatorSocket.on('connect', () => {
                    addLog('operatorLogs', '客服端Socket连接成功', 'success');
                    updateStatus('operatorStatus', '已连接', 'success');

                    document.getElementById('connectOperatorBtn').disabled = true;
                    document.getElementById('disconnectOperatorBtn').disabled = false;
                    document.getElementById('setOnlineBtn').disabled = false;
                });

                operatorSocket.on('disconnect', () => {
                    addLog('operatorLogs', '客服端Socket连接断开', 'warning');
                    updateStatus('operatorStatus', '已断开', 'error');

                    document.getElementById('connectOperatorBtn').disabled = false;
                    document.getElementById('disconnectOperatorBtn').disabled = true;
                    document.getElementById('setOnlineBtn').disabled = true;
                    document.getElementById('joinSessionBtn').disabled = true;
                });

                operatorSocket.on('operator-status-updated', (data) => {
                    addLog('operatorLogs', `状态更新: ${data.status}`, 'success');
                });

                operatorSocket.on('new-message-notification', (data) => {
                    addLog('operatorLogs', `收到新消息通知: ${data.content} (会话: ${data.sessionId})`, 'warning');
                    document.getElementById('joinSessionBtn').disabled = false;
                });

                operatorSocket.on('operator-session-joined', (data) => {
                    addLog('operatorLogs', `成功加入会话: ${data.sessionId}`, 'success');
                });

                operatorSocket.on('message-received', (data) => {
                    addLog('operatorLogs', `收到消息: ${data.content} (来自: ${data.senderType})`, 'success');
                });

                operatorSocket.on('chat-error', (data) => {
                    addLog('operatorLogs', `错误: ${data.error}`, 'error');
                });

            } catch (error) {
                addLog('operatorLogs', `连接失败: ${error.message}`, 'error');
                updateStatus('operatorStatus', '连接失败', 'error');
            }
        }

        // 断开客服端
        function disconnectOperator() {
            if (operatorSocket) {
                operatorSocket.emit('operator-status-change', {
                    operatorId: operatorId,
                    status: 'offline'
                });
                operatorSocket.disconnect();
                operatorSocket = null;
                operatorId = null;
            }
        }

        // 设置客服在线
        function setOperatorOnline() {
            if (!operatorSocket) {
                addLog('operatorLogs', '请先连接客服端', 'error');
                return;
            }

            addLog('operatorLogs', '设置客服状态为在线', 'info');
            operatorSocket.emit('operator-status-change', {
                operatorId: operatorId,
                status: 'online'
            });
        }

        // 加入会话
        function joinSession() {
            if (!operatorSocket || !sessionId) {
                addLog('operatorLogs', '请先确保有可用的会话', 'error');
                return;
            }

            addLog('operatorLogs', `客服加入会话: ${sessionId}`, 'info');
            operatorSocket.emit('operator-join-session', {
                operatorId: operatorId,
                sessionId: sessionId
            });
        }

        // 检查服务器状态
        function checkServerStatus() {
            addLog('serverLogs', '检查服务器状态...', 'info');

            fetch('http://localhost:3001/api/health')
                .then(response => {
                    if (response.ok) {
                        addLog('serverLogs', '服务器运行正常', 'success');
                        updateStatus('serverStatus', '运行正常', 'success');
                    } else {
                        addLog('serverLogs', `服务器响应异常: ${response.status}`, 'warning');
                        updateStatus('serverStatus', '响应异常', 'warning');
                    }
                })
                .catch(error => {
                    addLog('serverLogs', `服务器连接失败: ${error.message}`, 'error');
                    updateStatus('serverStatus', '连接失败', 'error');
                });
        }

        // 清空所有日志
        function clearAllLogs() {
            document.getElementById('userLogs').innerHTML = '';
            document.getElementById('operatorLogs').innerHTML = '';
            document.getElementById('serverLogs').innerHTML = '';
        }

        // 页面加载时检查服务器状态
        window.onload = function () {
            checkServerStatus();
            addLog('serverLogs', '消息流转测试工具已加载', 'info');
        };

        // 回车发送消息
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('userMessage').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendUserMessage();
                }
            });
        });
    </script>
</body>

</html>