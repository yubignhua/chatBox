<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ˆæ¯æµè½¬æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #409eff;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-panels {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #e4e7ed;
            font-weight: bold;
        }

        .panel-content {
            padding: 16px;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 5px 0;
        }

        .status.success {
            background: #f0f9ff;
            color: #1890ff;
        }

        .status.error {
            background: #fff2f0;
            color: #ff4d4f;
        }

        .status.warning {
            background: #fffbe6;
            color: #faad14;
        }

        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 12px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }

        .controls {
            margin: 10px 0;
        }

        .controls button {
            background: #409eff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 2px;
        }

        .controls button:hover {
            background: #337ecc;
        }

        .controls button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
        }

        .controls input {
            padding: 6px 12px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            margin: 2px;
        }

        @media (max-width: 768px) {
            .test-panels {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>æ¶ˆæ¯æµè½¬æµ‹è¯•å·¥å…·</h1>
            <p>æµ‹è¯•ç”¨æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œå®¢æœç«¯æ¥æ”¶é€šçŸ¥çš„å®Œæ•´æµç¨‹</p>
        </div>

        <div class="test-panels">
            <!-- ç”¨æˆ·ç«¯æµ‹è¯• -->
            <div class="panel">
                <div class="panel-header">ğŸ‘¤ ç”¨æˆ·ç«¯æµ‹è¯•</div>
                <div class="panel-content">
                    <div class="status" id="userStatus">æœªè¿æ¥</div>
                    <div class="controls">
                        <button onclick="connectUser()" id="connectUserBtn">è¿æ¥ç”¨æˆ·ç«¯</button>
                        <button onclick="disconnectUser()" id="disconnectUserBtn" disabled>æ–­å¼€è¿æ¥</button>
                    </div>
                    <div class="controls">
                        <input type="text" id="userMessage" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
                        <button onclick="sendUserMessage()" id="sendUserBtn" disabled>å‘é€æ¶ˆæ¯</button>
                    </div>
                    <div class="log-area" id="userLogs"></div>
                </div>
            </div>

            <!-- å®¢æœç«¯æµ‹è¯• -->
            <div class="panel">
                <div class="panel-header">ğŸ§ å®¢æœç«¯æµ‹è¯•</div>
                <div class="panel-content">
                    <div class="status" id="operatorStatus">æœªè¿æ¥</div>
                    <div class="controls">
                        <button onclick="connectOperator()" id="connectOperatorBtn">è¿æ¥å®¢æœç«¯</button>
                        <button onclick="disconnectOperator()" id="disconnectOperatorBtn" disabled>æ–­å¼€è¿æ¥</button>
                    </div>
                    <div class="controls">
                        <button onclick="setOperatorOnline()" id="setOnlineBtn" disabled>è®¾ç½®åœ¨çº¿</button>
                        <button onclick="joinSession()" id="joinSessionBtn" disabled>åŠ å…¥ä¼šè¯</button>
                    </div>
                    <div class="log-area" id="operatorLogs"></div>
                </div>
            </div>

            <!-- æœåŠ¡å™¨çŠ¶æ€ -->
            <div class="panel">
                <div class="panel-header">ğŸ–¥ï¸ æœåŠ¡å™¨çŠ¶æ€</div>
                <div class="panel-content">
                    <div class="status" id="serverStatus">æ£€æŸ¥ä¸­...</div>
                    <div class="controls">
                        <button onclick="checkServerStatus()">æ£€æŸ¥æœåŠ¡å™¨</button>
                        <button onclick="clearAllLogs()">æ¸…ç©ºæ—¥å¿—</button>
                    </div>
                    <div class="log-area" id="serverLogs"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">ğŸ“‹ æµ‹è¯•è¯´æ˜</div>
            <div class="panel-content">
                <ol>
                    <li><strong>è¿æ¥å®¢æœç«¯</strong>ï¼šç‚¹å‡»"è¿æ¥å®¢æœç«¯"æŒ‰é’®</li>
                    <li><strong>è®¾ç½®åœ¨çº¿</strong>ï¼šç‚¹å‡»"è®¾ç½®åœ¨çº¿"æŒ‰é’®</li>
                    <li><strong>è¿æ¥ç”¨æˆ·ç«¯</strong>ï¼šç‚¹å‡»"è¿æ¥ç”¨æˆ·ç«¯"æŒ‰é’®</li>
                    <li><strong>å‘é€æ¶ˆæ¯</strong>ï¼šåœ¨ç”¨æˆ·ç«¯è¾“å…¥æ¶ˆæ¯å¹¶å‘é€</li>
                    <li><strong>è§‚å¯Ÿé€šçŸ¥</strong>ï¼šå®¢æœç«¯åº”è¯¥æ”¶åˆ°æ¶ˆæ¯é€šçŸ¥</li>
                    <li><strong>åŠ å…¥ä¼šè¯</strong>ï¼šå®¢æœç‚¹å‡»"åŠ å…¥ä¼šè¯"æŒ‰é’®</li>
                    <li><strong>éªŒè¯é€šä¿¡</strong>ï¼šç¡®è®¤åŒæ–¹å¯ä»¥æ­£å¸¸é€šä¿¡</li>
                </ol>
                <p><strong>é¢„æœŸç»“æœ</strong>ï¼šç”¨æˆ·å‘é€æ¶ˆæ¯åï¼Œå®¢æœç«¯åº”è¯¥ç«‹å³æ”¶åˆ°é€šçŸ¥å¹¶æ˜¾ç¤ºåœ¨å¾…å¤„ç†ä¼šè¯ä¸­ã€‚</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let userSocket = null;
        let operatorSocket = null;
        let userId = null;
        let operatorId = null;
        let sessionId = null;

        // æ—¥å¿—å‡½æ•°
        function addLog(area, message, type = 'info') {
            const logArea = document.getElementById(area);
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#3498db',
                'success': '#2ecc71',
                'error': '#e74c3c',
                'warning': '#f39c12'
            };

            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #95a5a6;">[${timestamp}]</span> <span style="color: ${colorMap[type]};">${message}</span>`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // ç”ŸæˆID
        function generateId(prefix) {
            return prefix + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // è¿æ¥ç”¨æˆ·ç«¯
        function connectUser() {
            try {
                addLog('userLogs', 'æ­£åœ¨è¿æ¥ç”¨æˆ·ç«¯Socket...', 'info');

                userSocket = io('http://localhost:3001', {
                    transports: ['websocket', 'polling'],
                    timeout: 20000
                });

                userId = generateId('user');

                userSocket.on('connect', () => {
                    addLog('userLogs', 'ç”¨æˆ·ç«¯Socketè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('userStatus', 'å·²è¿æ¥', 'success');

                    document.getElementById('connectUserBtn').disabled = true;
                    document.getElementById('disconnectUserBtn').disabled = false;
                    document.getElementById('userMessage').disabled = false;
                    document.getElementById('sendUserBtn').disabled = false;

                    // åŠ å…¥èŠå¤©
                    userSocket.emit('user-join-chat', {
                        userId: userId,
                        name: 'æµ‹è¯•ç”¨æˆ·',
                        timestamp: new Date().toISOString()
                    });
                });

                userSocket.on('disconnect', () => {
                    addLog('userLogs', 'ç”¨æˆ·ç«¯Socketè¿æ¥æ–­å¼€', 'warning');
                    updateStatus('userStatus', 'å·²æ–­å¼€', 'error');

                    document.getElementById('connectUserBtn').disabled = false;
                    document.getElementById('disconnectUserBtn').disabled = true;
                    document.getElementById('userMessage').disabled = true;
                    document.getElementById('sendUserBtn').disabled = true;
                });

                userSocket.on('chat-session-created', (data) => {
                    sessionId = data.sessionId;
                    addLog('userLogs', `ä¼šè¯åˆ›å»ºæˆåŠŸ: ${sessionId}`, 'success');
                });

                userSocket.on('message-received', (data) => {
                    addLog('userLogs', `æ”¶åˆ°æ¶ˆæ¯: ${data.content} (æ¥è‡ª: ${data.senderType})`, 'success');
                });

                userSocket.on('operator-joined', (data) => {
                    addLog('userLogs', `å®¢æœå·²åŠ å…¥: ${data.operatorName}`, 'success');
                });

                userSocket.on('chat-error', (data) => {
                    addLog('userLogs', `é”™è¯¯: ${data.error}`, 'error');
                });

            } catch (error) {
                addLog('userLogs', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('userStatus', 'è¿æ¥å¤±è´¥', 'error');
            }
        }

        // æ–­å¼€ç”¨æˆ·ç«¯
        function disconnectUser() {
            if (userSocket) {
                userSocket.disconnect();
                userSocket = null;
                userId = null;
                sessionId = null;
            }
        }

        // å‘é€ç”¨æˆ·æ¶ˆæ¯
        function sendUserMessage() {
            const messageInput = document.getElementById('userMessage');
            const message = messageInput.value.trim();

            if (!message) {
                addLog('userLogs', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'warning');
                return;
            }

            if (!userSocket || !sessionId) {
                addLog('userLogs', 'è¯·å…ˆè¿æ¥å¹¶åˆ›å»ºä¼šè¯', 'error');
                return;
            }

            addLog('userLogs', `å‘é€æ¶ˆæ¯: ${message}`, 'info');

            userSocket.emit('user-send-message', {
                sessionId: sessionId,
                content: message,
                messageType: 'text'
            });

            messageInput.value = '';
        }

        // è¿æ¥å®¢æœç«¯
        function connectOperator() {
            try {
                addLog('operatorLogs', 'æ­£åœ¨è¿æ¥å®¢æœç«¯Socket...', 'info');

                operatorSocket = io('http://localhost:3001', {
                    transports: ['websocket', 'polling'],
                    timeout: 20000
                });

                operatorId = generateId('operator');

                operatorSocket.on('connect', () => {
                    addLog('operatorLogs', 'å®¢æœç«¯Socketè¿æ¥æˆåŠŸ', 'success');
                    updateStatus('operatorStatus', 'å·²è¿æ¥', 'success');

                    document.getElementById('connectOperatorBtn').disabled = true;
                    document.getElementById('disconnectOperatorBtn').disabled = false;
                    document.getElementById('setOnlineBtn').disabled = false;
                });

                operatorSocket.on('disconnect', () => {
                    addLog('operatorLogs', 'å®¢æœç«¯Socketè¿æ¥æ–­å¼€', 'warning');
                    updateStatus('operatorStatus', 'å·²æ–­å¼€', 'error');

                    document.getElementById('connectOperatorBtn').disabled = false;
                    document.getElementById('disconnectOperatorBtn').disabled = true;
                    document.getElementById('setOnlineBtn').disabled = true;
                    document.getElementById('joinSessionBtn').disabled = true;
                });

                operatorSocket.on('operator-status-updated', (data) => {
                    addLog('operatorLogs', `çŠ¶æ€æ›´æ–°: ${data.status}`, 'success');
                });

                operatorSocket.on('new-message-notification', (data) => {
                    addLog('operatorLogs', `æ”¶åˆ°æ–°æ¶ˆæ¯é€šçŸ¥: ${data.content} (ä¼šè¯: ${data.sessionId})`, 'warning');
                    document.getElementById('joinSessionBtn').disabled = false;
                });

                operatorSocket.on('operator-session-joined', (data) => {
                    addLog('operatorLogs', `æˆåŠŸåŠ å…¥ä¼šè¯: ${data.sessionId}`, 'success');
                });

                operatorSocket.on('message-received', (data) => {
                    addLog('operatorLogs', `æ”¶åˆ°æ¶ˆæ¯: ${data.content} (æ¥è‡ª: ${data.senderType})`, 'success');
                });

                operatorSocket.on('chat-error', (data) => {
                    addLog('operatorLogs', `é”™è¯¯: ${data.error}`, 'error');
                });

            } catch (error) {
                addLog('operatorLogs', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus('operatorStatus', 'è¿æ¥å¤±è´¥', 'error');
            }
        }

        // æ–­å¼€å®¢æœç«¯
        function disconnectOperator() {
            if (operatorSocket) {
                operatorSocket.emit('operator-status-change', {
                    operatorId: operatorId,
                    status: 'offline'
                });
                operatorSocket.disconnect();
                operatorSocket = null;
                operatorId = null;
            }
        }

        // è®¾ç½®å®¢æœåœ¨çº¿
        function setOperatorOnline() {
            if (!operatorSocket) {
                addLog('operatorLogs', 'è¯·å…ˆè¿æ¥å®¢æœç«¯', 'error');
                return;
            }

            addLog('operatorLogs', 'è®¾ç½®å®¢æœçŠ¶æ€ä¸ºåœ¨çº¿', 'info');
            operatorSocket.emit('operator-status-change', {
                operatorId: operatorId,
                status: 'online'
            });
        }

        // åŠ å…¥ä¼šè¯
        function joinSession() {
            if (!operatorSocket || !sessionId) {
                addLog('operatorLogs', 'è¯·å…ˆç¡®ä¿æœ‰å¯ç”¨çš„ä¼šè¯', 'error');
                return;
            }

            addLog('operatorLogs', `å®¢æœåŠ å…¥ä¼šè¯: ${sessionId}`, 'info');
            operatorSocket.emit('operator-join-session', {
                operatorId: operatorId,
                sessionId: sessionId
            });
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        function checkServerStatus() {
            addLog('serverLogs', 'æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 'info');

            fetch('http://localhost:3001/api/health')
                .then(response => {
                    if (response.ok) {
                        addLog('serverLogs', 'æœåŠ¡å™¨è¿è¡Œæ­£å¸¸', 'success');
                        updateStatus('serverStatus', 'è¿è¡Œæ­£å¸¸', 'success');
                    } else {
                        addLog('serverLogs', `æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`, 'warning');
                        updateStatus('serverStatus', 'å“åº”å¼‚å¸¸', 'warning');
                    }
                })
                .catch(error => {
                    addLog('serverLogs', `æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    updateStatus('serverStatus', 'è¿æ¥å¤±è´¥', 'error');
                });
        }

        // æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
        function clearAllLogs() {
            document.getElementById('userLogs').innerHTML = '';
            document.getElementById('operatorLogs').innerHTML = '';
            document.getElementById('serverLogs').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.onload = function () {
            checkServerStatus();
            addLog('serverLogs', 'æ¶ˆæ¯æµè½¬æµ‹è¯•å·¥å…·å·²åŠ è½½', 'info');
        };

        // å›è½¦å‘é€æ¶ˆæ¯
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('userMessage').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    sendUserMessage();
                }
            });
        });
    </script>
</body>

</html>